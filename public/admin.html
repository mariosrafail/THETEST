<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin</title>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    .grid3{
      display:grid;
      grid-template-columns: 1.2fr 1fr 0.8fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid3{grid-template-columns:1fr}
    }
    .help{font-size:12px; color:var(--muted); margin-top:6px}
    .row2{display:flex; gap:10px; align-items:center}
    .row2 > *{flex:1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start; gap:16px;">
        <div>
          <h1>Admin Panel</h1>
          <!-- <p class="muted">Basic auth is required. Use your admin username and password.</p> -->
        </div>
        <a class="btn" href="/candidates.html">Open Candidates</a>
      </div>

      <div class="grid3" style="margin-top:16px;">
        <div>
          <h2>Create Session Link</h2>
          <label class="label">Candidate name</label>
          <input id="candidateName" class="input" value="Candidate"/>
          <button id="btnGenerate" class="btn primary" style="margin-top:12px; width:100%;">Generate Link</button>
          <div id="out" class="muted" style="margin-top:10px;"></div>
        </div>

        <div>
          <h2>Exam Window</h2>

          <label class="label">Opens at (date and time)</label>
          <input id="openDT" class="input mono" type="datetime-local" step="60" />
          <div class="help"><span id="openUtcPreview" class="mono">-</span></div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label class="label">Duration (minutes)</label>
              <input id="durationMin" class="input mono" type="number" min="1" step="1" value="60"/>
            </div>
            <div>
              <label class="label">Duration (seconds)</label>
              <input id="durationSec" class="input mono" type="number" min="1" step="1" value="3600"/>
            </div>
          </div>

          <!-- <div class="help">Candidates can enter only from open time until open time plus duration. Before that they see a countdown, after that they see "Exam ended".</div> -->

          <button id="btnSaveCfg" class="btn primary" style="margin-top:12px; width:100%;">Save Config</button>
          <div id="cfgOut" class="help"></div>
        </div>

        <div>
          <h2>Status</h2>
          <div class="notice" id="statusBox" style="display:block;">
            <div class="muted">Server time</div>
            <div id="serverNow" class="mono" style="font-weight:800; margin-top:6px;">-</div>
            <div class="hr" style="margin:12px 0;"></div>
            <div class="muted">Current window</div>
            <div id="windowLine" class="mono" style="margin-top:6px;">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { apiGet, apiPost, qs, escapeHtml } from "./app.js";

  const elName = qs("#candidateName");
  const elGen = qs("#btnGenerate");
  const elOut = qs("#out");

  const elOpenDT = qs("#openDT");
  const elOpenUtcPreview = qs("#openUtcPreview");
  const elDurMin = qs("#durationMin");
  const elDurSec = qs("#durationSec");
  const elSave = qs("#btnSaveCfg");
  const elCfgOut = qs("#cfgOut");

  const elServerNow = qs("#serverNow");
  const elWindowLine = qs("#windowLine");

  function toIsoZ(ms){
    const d = new Date(Number(ms));
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const pad = (n)=> String(n).padStart(2,'0');
    const dd = pad(d.getUTCDate());
    const mon = months[d.getUTCMonth()];
    const yyyy = d.getUTCFullYear();
    const hh = pad(d.getUTCHours());
    const mm = pad(d.getUTCMinutes());
    return `${dd} ${mon} ${yyyy}, ${hh}:${mm} UTC`;
  }

  function toDatetimeLocalValue(ms){
    const d = new Date(Number(ms));
    const pad = (n)=> String(n).padStart(2,'0');
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    return `${y}-${m}-${day}T${hh}:${mm}`;
  }

  // datetime-local has no timezone. We treat its value as LOCAL time and convert to UTC ms.
  function parseDatetimeLocalToMs(v){
    const s = String(v || '').trim();
    if (!s) return null;
    const d = new Date(s);
    const ms = d.getTime();
    if (!Number.isFinite(ms)) return null;
    return ms;
  }

  function syncDurFields(from){
    const min = Number(elDurMin.value || 0);
    const sec = Number(elDurSec.value || 0);
    if (from === "min"){
      elDurSec.value = String(Math.max(1, Math.round(min * 60)));
    } else if (from === "sec"){
      elDurMin.value = String(Math.max(1, Math.round(sec / 60)));
    }
  }

  elDurMin.addEventListener("input", ()=> syncDurFields("min"));
  elDurSec.addEventListener("input", ()=> syncDurFields("sec"));

  async function loadCfg(){
    const cfg = await apiGet("/api/admin/config");
    elServerNow.textContent = toIsoZ(cfg.serverNow);
    elOpenDT.value = toDatetimeLocalValue(cfg.openAtUtc);
    elOpenUtcPreview.textContent = toIsoZ(cfg.openAtUtc);
    elDurSec.value = String(cfg.durationSeconds || 3600);
    syncDurFields("sec");

    const endAt = Number(cfg.openAtUtc) + Number(cfg.durationSeconds || 0) * 1000;
    elWindowLine.textContent = `${toIsoZ(cfg.openAtUtc)}  to  ${toIsoZ(endAt)}`;
  }

  function updateOpenPreview(){
    const ms = parseDatetimeLocalToMs(elOpenDT.value);
    elOpenUtcPreview.textContent = ms == null ? '-' : toIsoZ(ms);
  }

  elOpenDT.addEventListener('input', updateOpenPreview);

  elGen.addEventListener("click", async () => {
    try {
      elGen.disabled = true;
      elOut.textContent = "Generating...";
      const data = await apiPost("/api/admin/create-session", { candidateName: elName.value });
      const url = data.url || "";
      elOut.innerHTML = `
        <div><span class="muted">Session:</span> <span class="mono">${escapeHtml(String(data.sessionId))}</span></div>
        <div style="margin-top:8px;"><a class="mono" href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(location.origin + url)}</a></div>
      `;
    } catch (e) {
      elOut.innerHTML = `<span class="bad">Error: ${escapeHtml(e.message || String(e))}</span>`;
    } finally {
      elGen.disabled = false;
    }
  });

  elSave.addEventListener("click", async () => {
    try {
      elSave.disabled = true;
      elCfgOut.innerHTML = "";
      const openMs = parseDatetimeLocalToMs(elOpenDT.value);
      if (openMs === null) throw new Error("Invalid open date/time");

      const durSeconds = Number(elDurSec.value || 0);
      if (!Number.isFinite(durSeconds) || durSeconds <= 0) throw new Error("Invalid duration");

      const out = await apiPost("/api/admin/config", { openAtUtc: openMs, durationSeconds: durSeconds });

      elCfgOut.innerHTML = `<span class="ok">Saved.</span>`;
      elServerNow.textContent = toIsoZ(out.serverNow);
      elOpenUtcPreview.textContent = toIsoZ(out.openAtUtc);
      const endAt = Number(out.openAtUtc) + Number(out.durationSeconds || 0) * 1000;
      elWindowLine.textContent = `${toIsoZ(out.openAtUtc)}  to  ${toIsoZ(endAt)}`;
    } catch (e) {
      elCfgOut.innerHTML = `<span class="bad">Error: ${escapeHtml(e.message || String(e))}</span>`;
    } finally {
      elSave.disabled = false;
    }
  });

  loadCfg().catch(e=>{
    elCfgOut.innerHTML = `<span class="bad">Failed to load config: ${escapeHtml(e.message || String(e))}</span>`;
  });
</script>
</body>
</html>
